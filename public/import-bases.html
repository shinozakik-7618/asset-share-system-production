<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h1>
  <p>1. ã¾ãšãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</p>
  <button onclick="login()" style="padding: 15px; font-size: 16px; margin: 10px;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
  <br>
  <p>2. Excelãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆã‚¿ãƒ–åŒºåˆ‡ã‚Šï¼‰</p>
  <textarea id="excelData" rows="10" cols="80" placeholder="Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„"></textarea>
  <br>
  <button onclick="importData()" style="padding: 15px; font-size: 16px; margin: 10px; background: #4caf50; color: white;">ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹</button>
  <div id="log" style="margin-top: 20px; font-family: monospace;"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDk3cBLq7K4y61Nt0MeniXaEmfMWmLTOp0",
      authDomain: "asset-sharing-production.firebaseapp.com",
      projectId: "asset-sharing-production"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    function log(message) {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML += message + '<br>';
      console.log(message);
    }

    async function login() {
      try {
        await auth.signInWithPopup(googleProvider);
        log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ' + auth.currentUser.email);
      } catch (error) {
        log('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    async function importData() {
      if (!auth.currentUser) {
        log('âŒ å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const excelData = document.getElementById('excelData').value;
        const lines = excelData.trim().split('\n');
        
        log('ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’è§£æä¸­...');
        
        const bases = [];
        const uniqueBases = new Set();
        
        for (let i = 0; i < lines.length; i++) {
          const columns = lines[i].split('\t');
          
          if (columns.length < 6) continue;
          
          const blockName = columns[1].trim();
          const regionName = columns[3].trim();
          const baseName = columns[5].trim();
          
          if (!blockName || !regionName || !baseName) continue;
          if (blockName === 'ãƒ–ãƒ­ãƒƒã‚¯') continue; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
          
          const key = `${blockName}_${regionName}_${baseName}`;
          if (uniqueBases.has(key)) continue;
          uniqueBases.add(key);
          
          bases.push({
            blockName: blockName,
            regionName: regionName,
            baseName: baseName,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        log(`âœ… ${bases.length}ä»¶ã®æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’è§£æã—ã¾ã—ãŸ`);
        log('ğŸ“¥ Firestoreã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');
        
        let batch = db.batch();
        let count = 0;
        
        for (const base of bases) {
          const docRef = db.collection('baseMaster').doc();
          batch.set(docRef, base);
          count++;
          
          if (count % 500 === 0) {
            await batch.commit();
            log(`  ${count}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ¸ˆã¿...`);
            batch = db.batch();
          }
        }
        
        if (count % 500 !== 0) {
          await batch.commit();
        }
        
        log(`âœ… å®Œäº†ï¼${count}ä»¶ã®æ‹ ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        
      } catch (error) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
        console.error(error);
      }
    }
  </script>
</body>
</html>
